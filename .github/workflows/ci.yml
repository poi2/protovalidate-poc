name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  ci:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install buf
        uses: bufbuild/buf-setup-action@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install markdownlint
        run: npm install -g markdownlint-cli

      - name: Install runn
        run: go install github.com/k1LoW/runn/cmd/runn@latest

      - name: Proto lint
        run: make proto-lint

      - name: Markdown lint
        run: make md-lint

      - name: Check proto generation is up to date
        run: |
          cd proto && buf dep update && buf generate
          git diff --exit-code go/gen || (echo "Generated code is not up to date. Run 'make proto-generate' and commit the changes." && exit 1)

      - name: Go mod tidy check
        run: |
          go mod tidy
          git diff --exit-code go.mod go.sum || (echo "go.mod or go.sum is not tidy. Run 'go mod tidy' and commit the changes." && exit 1)

      - name: Run tests
        run: make test

      - name: Build server
        run: make build

      - name: Run integration tests
        run: make integration-test-full

      - name: Upload coverage
        uses: codecov/codecov-action@v5
        if: always()
        with:
          files: ./coverage.out
          fail_ci_if_error: false
