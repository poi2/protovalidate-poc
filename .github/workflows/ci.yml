name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    # 毎日24:00 JST (15:00 UTC)に実行
    - cron: '0 15 * * *'

jobs:
  # 変更されたファイルを検出
  check-changes:
    runs-on: ubuntu-latest
    outputs:
      markdown: ${{ steps.set-outputs.outputs.markdown }}
      proto: ${{ steps.set-outputs.outputs.proto }}
      go: ${{ steps.set-outputs.outputs.go }}
      typescript: ${{ steps.set-outputs.outputs.typescript }}
      ci-config: ${{ steps.set-outputs.outputs.ci-config }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check changed files
        uses: dorny/paths-filter@v3
        id: filter
        # PR以外（mainへのpushまたはschedule）の場合はスキップ
        if: github.event_name == 'pull_request'
        with:
          filters: |
            markdown:
              - '**/*.md'
            proto:
              - 'proto/**'
              - 'buf.work.yaml'
            go:
              - 'go/**'
              - '*.go'
              - 'go.mod'
              - 'go.sum'
              - 'proto/**'
            typescript:
              - 'ts/**'
              - 'proto/**'
            ci-config:
              - '.github/workflows/**'
              - 'Makefile'
              - 'scripts/**'

      - name: Set outputs
        id: set-outputs
        run: |
          # mainブランチへのpushまたはschedule実行の場合は全て実行
          if [[ "${{ github.event_name }}" == "push" || "${{ github.event_name }}" == "schedule" ]]; then
            echo "markdown=true" >> $GITHUB_OUTPUT
            echo "proto=true" >> $GITHUB_OUTPUT
            echo "go=true" >> $GITHUB_OUTPUT
            echo "typescript=true" >> $GITHUB_OUTPUT
            echo "ci-config=true" >> $GITHUB_OUTPUT
            echo "Running all checks (main push or scheduled run)"
          else
            # PRの場合は変更検出結果を使用
            echo "markdown=${{ steps.filter.outputs.markdown }}" >> $GITHUB_OUTPUT
            echo "proto=${{ steps.filter.outputs.proto }}" >> $GITHUB_OUTPUT
            echo "go=${{ steps.filter.outputs.go }}" >> $GITHUB_OUTPUT
            echo "typescript=${{ steps.filter.outputs.typescript }}" >> $GITHUB_OUTPUT
            echo "ci-config=${{ steps.filter.outputs.ci-config }}" >> $GITHUB_OUTPUT
            echo "Running checks based on changed files (PR)"
          fi

  # Markdown lint
  markdown-lint:
    needs: check-changes
    if: needs.check-changes.outputs.markdown == 'true' || needs.check-changes.outputs.ci-config == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install markdownlint
        run: npm install -g markdownlint-cli

      - name: Run markdownlint
        run: make md-lint

  # Proto checks
  proto-checks:
    needs: check-changes
    if: needs.check-changes.outputs.proto == 'true' || needs.check-changes.outputs.ci-config == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install buf
        uses: bufbuild/buf-setup-action@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}

      - name: Proto lint
        run: make proto-lint

      - name: Check proto generation is up to date
        run: |
          cd proto && buf dep update && buf generate
          cd ..
          git diff --exit-code go/gen ts/gen || (echo "Generated code is not up to date. Run 'make proto-generate' and commit the changes." && exit 1)

  # Go checks
  go-checks:
    needs: check-changes
    if: needs.check-changes.outputs.go == 'true' || needs.check-changes.outputs.ci-config == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'

      - name: Install buf
        uses: bufbuild/buf-setup-action@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate proto files
        run: cd proto && buf dep update && buf generate

      - name: Go mod tidy check
        run: |
          go mod tidy
          git diff --exit-code go.mod go.sum || (echo "go.mod or go.sum is not tidy. Run 'go mod tidy' and commit the changes." && exit 1)

      - name: Run tests
        run: make test

      - name: Build server
        run: make build

      - name: Upload coverage
        uses: codecov/codecov-action@v5
        if: always()
        with:
          files: ./coverage.out
          fail_ci_if_error: false

  # TypeScript checks
  typescript-checks:
    needs: check-changes
    if: needs.check-changes.outputs.typescript == 'true' || needs.check-changes.outputs.ci-config == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: ts/package-lock.json

      - name: Install buf
        uses: bufbuild/buf-setup-action@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate proto files
        run: cd proto && buf dep update && buf generate

      - name: Install TypeScript dependencies
        run: make ts-install

      - name: TypeScript type check
        run: make ts-typecheck

      - name: Run TypeScript tests
        run: make ts-test

  # Integration tests
  integration-tests:
    needs: [check-changes, go-checks]
    if: |
      always() &&
      (needs.check-changes.outputs.go == 'true' ||
       needs.check-changes.outputs.proto == 'true' ||
       needs.check-changes.outputs.ci-config == 'true') &&
      (needs.go-checks.result == 'success' || needs.go-checks.result == 'skipped')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'

      - name: Install buf
        uses: bufbuild/buf-setup-action@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate proto files
        run: cd proto && buf dep update && buf generate

      - name: Install runn
        run: go install github.com/k1LoW/runn/cmd/runn@latest

      - name: Run integration tests
        run: make integration-test-full

  # CI成功チェック
  ci-success:
    needs: [markdown-lint, proto-checks, go-checks, typescript-checks, integration-tests]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Check all jobs
        run: |
          echo "markdown-lint: ${{ needs.markdown-lint.result }}"
          echo "proto-checks: ${{ needs.proto-checks.result }}"
          echo "go-checks: ${{ needs.go-checks.result }}"
          echo "typescript-checks: ${{ needs.typescript-checks.result }}"
          echo "integration-tests: ${{ needs.integration-tests.result }}"

          # 全てのジョブが success または skipped であることを確認
          if [[ "${{ needs.markdown-lint.result }}" != "success" && "${{ needs.markdown-lint.result }}" != "skipped" ]]; then
            echo "markdown-lint failed"
            exit 1
          fi
          if [[ "${{ needs.proto-checks.result }}" != "success" && "${{ needs.proto-checks.result }}" != "skipped" ]]; then
            echo "proto-checks failed"
            exit 1
          fi
          if [[ "${{ needs.go-checks.result }}" != "success" && "${{ needs.go-checks.result }}" != "skipped" ]]; then
            echo "go-checks failed"
            exit 1
          fi
          if [[ "${{ needs.typescript-checks.result }}" != "success" && "${{ needs.typescript-checks.result }}" != "skipped" ]]; then
            echo "typescript-checks failed"
            exit 1
          fi
          if [[ "${{ needs.integration-tests.result }}" != "success" && "${{ needs.integration-tests.result }}" != "skipped" ]]; then
            echo "integration-tests failed"
            exit 1
          fi

          echo "All CI checks passed or skipped successfully!"
