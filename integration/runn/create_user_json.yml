desc: CreateUser API tests (JSON only)
runners:
  req: http://localhost:8080

vars:
  valid_user:
    name: "John Doe"
    email: "john@example.com"
    password: "password123"
    password_confirmation: "password123"

steps:
  # Test 1: Valid user creation
  - desc: "Create user with valid data"
    req:
      /user.v1.UserService/CreateUser:
        post:
          body:
            application/json:
              name: "{{ vars.valid_user.name }}"
              email: "{{ vars.valid_user.email }}"
              password: "{{ vars.valid_user.password }}"
              passwordConfirmation: "{{ vars.valid_user.password_confirmation }}"
  - test: steps[0].res.status == 200
  - test: steps[0].res.body.user.name == "John Doe"
  - test: steps[0].res.body.user.email == "john@example.com"
  - test: steps[0].res.body.user.id != ""

  # Test 2: Validation error - empty name
  - desc: "Validation error - empty name"
    req:
      /user.v1.UserService/CreateUser:
        post:
          body:
            application/json:
              name: ""
              email: "john@example.com"
              password: "password123"
              passwordConfirmation: "password123"
  - test: steps[5].res.status == 400
  - test: steps[5].res.body.code == "invalid_argument"
  - test: len(steps[5].res.body.details) == 1
  - test: steps[5].res.body.details[0].type == "google.rpc.BadRequest"
  - test: len(steps[5].res.body.details[0].debug.fieldViolations) == 1
  - test: steps[5].res.body.details[0].debug.fieldViolations[0].field == "name"
  - test: steps[5].res.body.details[0].debug.fieldViolations[0].reason == "STRING_MIN_LEN"

  # Test 3: Validation error - invalid email
  - desc: "Validation error - invalid email"
    req:
      /user.v1.UserService/CreateUser:
        post:
          body:
            application/json:
              name: "John Doe"
              email: "not-an-email"
              password: "password123"
              passwordConfirmation: "password123"
  - test: steps[13].res.status == 400
  - test: steps[13].res.body.code == "invalid_argument"
  - test: len(steps[13].res.body.details) == 1
  - test: steps[13].res.body.details[0].type == "google.rpc.BadRequest"
  - test: len(steps[13].res.body.details[0].debug.fieldViolations) == 1
  - test: steps[13].res.body.details[0].debug.fieldViolations[0].field == "email"
  - test: steps[13].res.body.details[0].debug.fieldViolations[0].reason == "STRING_EMAIL"

  # Test 4: Validation error - password too short
  - desc: "Validation error - password too short"
    req:
      /user.v1.UserService/CreateUser:
        post:
          body:
            application/json:
              name: "John Doe"
              email: "john@example.com"
              password: "short"
              passwordConfirmation: "short"
  - test: steps[21].res.status == 400
  - test: steps[21].res.body.code == "invalid_argument"
  - test: len(steps[21].res.body.details) == 1
  - test: steps[21].res.body.details[0].type == "google.rpc.BadRequest"
  - test: len(steps[21].res.body.details[0].debug.fieldViolations) == 1
  - test: steps[21].res.body.details[0].debug.fieldViolations[0].field == "password"
  - test: steps[21].res.body.details[0].debug.fieldViolations[0].reason == "STRING_MIN_LEN"

  # Test 5: Validation error - passwords do not match
  - desc: "Validation error - passwords do not match"
    req:
      /user.v1.UserService/CreateUser:
        post:
          body:
            application/json:
              name: "John Doe"
              email: "john@example.com"
              password: "password123"
              passwordConfirmation: "different"
  - test: steps[29].res.status == 400
  - test: steps[29].res.body.code == "invalid_argument"
  - test: len(steps[29].res.body.details) == 1
  - test: steps[29].res.body.details[0].type == "google.rpc.BadRequest"
  - test: len(steps[29].res.body.details[0].debug.fieldViolations) == 1
  - test: steps[29].res.body.details[0].debug.fieldViolations[0].reason == "PASSWORD_MISMATCH"
  - test: steps[29].res.body.details[0].debug.fieldViolations[0].description == "passwords must match"
