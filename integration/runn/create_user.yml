desc: CreateUser API tests (JSON and gRPC)
runners:
  req_json: http://localhost:8080
  req_grpc:
    addr: localhost:8080
    tls: false

vars:
  valid_user:
    name: "John Doe"
    email: "john@example.com"
    password: "password123"

steps:
  # JSON Test 1: Valid user creation
  - desc: "JSON: Create user with valid data"
    req_json:
      /user.v1.UserService/CreateUser:
        post:
          body:
            application/json:
              name: "{{ vars.valid_user.name }}"
              email: "{{ vars.valid_user.email }}"
              password: "{{ vars.valid_user.password }}"
              passwordConfirmation: "{{ vars.valid_user.password }}"
  - test: steps[0].res.status == 200
  - test: steps[0].res.body.user.name == "John Doe"
  - test: steps[0].res.body.user.email == "john@example.com"
  - test: steps[0].res.body.user.id != ""

  # JSON Test 2: Validation error - empty name
  - desc: "JSON: Validation error - empty name"
    req_json:
      /user.v1.UserService/CreateUser:
        post:
          body:
            application/json:
              name: ""
              email: "john@example.com"
              password: "password123"
              passwordConfirmation: "password123"
  - test: steps[5].res.status == 400

  # gRPC Test 1: Valid user creation
  - desc: "gRPC: Create user with valid data"
    req_grpc:
      user.v1.UserService/CreateUser:
        message:
          name: "{{ vars.valid_user.name }}"
          email: "{{ vars.valid_user.email }}"
          password: "{{ vars.valid_user.password }}"
          password_confirmation: "{{ vars.valid_user.password }}"
  - test: steps[7].res.message.user.name == "John Doe"
  - test: steps[7].res.message.user.email == "john@example.com"
  - test: steps[7].res.message.user.id != ""

  # gRPC Test 2: Validation error - empty name
  - desc: "gRPC: Validation error - empty name (expect error)"
    req_grpc:
      user.v1.UserService/CreateUser:
        message:
          name: ""
          email: "john@example.com"
          password: "password123"
          password_confirmation: "password123"
        test:
          - steps[11].res.status != 0  # Expect error status

  # gRPC Test 3: Validation error - passwords do not match
  - desc: "gRPC: Validation error - passwords do not match (expect error)"
    req_grpc:
      user.v1.UserService/CreateUser:
        message:
          name: "John Doe"
          email: "john@example.com"
          password: "password123"
          password_confirmation: "different"
        test:
          - steps[12].res.status != 0  # Expect error status
